# 生产环境部署说明

## 系统要求

- CentOS 7 服务器
- Docker (推荐版本 1.13.1+)
- Docker Compose (推荐版本 1.18.0+)

## 部署步骤

### 1. 安装 Docker 和 Docker Compose

```bash
# 您的系统已安装Docker 1.13.1版本和Docker Compose 1.18.0版本，可以跳过此步骤
```

### 2. 克隆项目代码

```bash
git clone <项目仓库地址>
cd jingGong
```

### 3. 构建和启动服务

由于您的Docker Compose版本较旧，我们提供了兼容的配置文件：

```bash
# 验证配置文件格式
docker-compose config

# 构建镜像（此过程可能需要较长时间，特别是在网络较慢的情况下）
docker-compose build

# 启动服务
docker-compose up -d
```

### 4. 监控部署过程

由于远程连接可能出现画面静止的情况，您可以使用以下方法监控部署过程：

```bash
# 在另一个终端窗口中运行以下命令，监控容器状态
docker-compose ps

# 查看服务日志
docker-compose logs -f web
docker-compose logs -f db

# 或者创建一个监控脚本
chmod +x deploy_check.sh
./deploy_check.sh
```

### 5. 访问应用

应用将在8000端口提供服务，可通过服务器IP和端口直接访问（例如：http://139.196.176.20:8000）。

## 环境变量配置

可以通过修改 docker-compose.yml 文件中的 environment 部分来配置环境变量：

- `DEBUG`: 设置为 0 以禁用调试模式

## 管理命令

```bash
# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f web

# 停止服务
docker-compose down

# 重启服务
docker-compose restart

# 监控部署状态
chmod +x deploy_check.sh
./deploy_check.sh
```

## 数据备份和恢复

### 备份数据库

```bash
docker exec -t jinggong_db_1 pg_dump -U postgres machining_platform > backup.sql
```

### 恢复数据库

```bash
docker exec -T jinggong_db_1 psql -U postgres machining_platform < backup.sql
```

## 常见问题

### 1. Docker Compose 版本兼容性

您的系统使用的是 Docker Compose 1.18.0 版本，这是一个较旧的版本。我们已经调整了配置文件格式以确保兼容性，使用了 version '2' 格式。

### 2. 服务架构简化

由于Docker Compose版本限制，当前配置仅包含Web应用和数据库服务，没有包含Nginx反向代理。应用将直接通过8000端口访问。

### 3. 端口冲突

如果 8000 端口已被占用，可以修改 docker-compose.yml 中 web 服务的端口映射。

### 4. 权限问题

确保运行 docker 命令的用户具有相应权限，或将用户添加到 docker 组：

```bash
sudo usermod -aG docker $USER
```

### 5. 部署过程中画面静止

在远程连接中，特别是在网络较慢的情况下，您可能会遇到画面静止的情况。这通常是正常的，因为：

1. Docker正在下载基础镜像（可能需要较长时间）
2. 正在安装Python依赖包
3. 正在执行数据库迁移

要确认进程是否正常运行，可以：
- 在另一个终端窗口中运行 `docker-compose ps` 查看容器状态
- 运行 `docker-compose logs -f web` 实时查看web服务日志
- 运行 `docker-compose logs -f db` 实时查看数据库服务日志
- 使用我们提供的 `deploy_check.sh` 脚本检查部署状态

### 6. 配置文件验证

如果遇到配置文件相关的错误，可以使用以下命令验证配置文件格式：

```bash
docker-compose config
```

这将显示解析后的配置，如果有格式错误会提示具体信息。