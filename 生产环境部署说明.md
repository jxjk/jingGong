# 生产环境部署说明

## 系统要求

- CentOS 7 服务器
- Docker (推荐版本 1.13.1+)
- Docker Compose (推荐版本 1.18.0+)

## 部署步骤

### 1. 安装 Docker 和 Docker Compose

```bash
# 您的系统已安装Docker 1.13.1版本和Docker Compose 1.18.0版本，可以跳过此步骤
```

### 2. 配置Docker镜像加速器

您已经配置了阿里云镜像加速器，配置如下：
```json
{
  "registry-mirrors": ["https://77n6chx1.mirror.aliyuncs.com"]
}
```

关键说明：阿里云镜像加速器已完整代理 Docker Hub 官方镜像（包括 library/ubuntu 和 library/postgres），配置后无需修改 docker-compose.yml，Docker会自动通过加速器拉取镜像。

### 3. 克隆项目代码

```bash
git clone <项目仓库地址>
cd jingGong
```

### 4. 构建和启动服务

由于您的Docker Compose版本较旧，我们提供了兼容的配置文件：

```bash
# 验证配置文件格式
docker-compose config

# 构建镜像（此过程可能需要较长时间，特别是在网络较慢的情况下）
docker-compose build

# 如果遇到网络超时问题，可以尝试以下方法：
# 1. 增加Docker的网络超时时间
# export DOCKER_CLIENT_TIMEOUT=120
# export COMPOSE_HTTP_TIMEOUT=120
# docker-compose build

# 启动服务
docker-compose up -d
```

### 5. 监控部署过程

由于远程连接可能出现画面静止的情况，您可以使用以下方法监控部署过程：

```bash
# 在另一个终端窗口中运行以下命令，监控容器状态
docker-compose ps

# 查看服务日志
docker-compose logs -f web
docker-compose logs -f db

# 或者创建一个监控脚本
chmod +x deploy_check.sh
./deploy_check.sh
```

### 6. 访问应用

应用将在8000端口提供服务，可通过服务器IP和端口直接访问（例如：http://139.196.176.20:8000）。

## 环境变量配置

可以通过修改 docker-compose.yml 文件中的 environment 部分来配置环境变量：

- `DEBUG`: 设置为 0 以禁用调试模式

## 管理命令

```bash
# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f web

# 停止服务
docker-compose down

# 重启服务
docker-compose restart
```

## 数据备份和恢复

### 备份数据库

```bash
docker exec -t jinggong_db_1 pg_dump -U postgres machining_platform > backup.sql
```

### 恢复数据库

```bash
docker exec -T jinggong_db_1 psql -U postgres machining_platform < backup.sql
```

## 常见问题

### 1. Docker Compose 版本兼容性

您的系统使用的是 Docker Compose 1.18.0 版本，这是一个较旧的版本。我们已经调整了配置文件格式以确保兼容性，使用了 version '2' 格式。

### 2. 服务架构简化

由于Docker Compose版本限制，当前配置仅包含Web应用和数据库服务，没有包含Nginx反向代理。应用将直接通过8000端口访问。

### 3. 端口冲突

如果 8000 端口已被占用，可以修改 docker-compose.yml 中 web 服务的端口映射。

### 4. 权限问题

确保运行 docker 命令的用户具有相应权限，或将用户添加到 docker 组：

```bash
sudo usermod -aG docker $USER
```

### 5. 部署过程中画面静止

在远程连接中，特别是在网络较慢的情况下，您可能会遇到画面静止的情况。这通常是正常的，因为：

1. Docker正在下载基础镜像（可能需要较长时间）
2. 正在安装Python依赖包
3. 正在执行数据库迁移

要确认进程是否正常运行，可以：
- 在另一个终端窗口中运行 `docker-compose ps` 查看容器状态
- 运行 `docker-compose logs -f web` 实时查看web服务日志
- 运行 `docker-compose logs -f db` 实时查看数据库服务日志
- 使用我们提供的 `deploy_check.sh` 脚本检查部署状态

### 6. 配置文件验证

如果遇到配置文件相关的错误，可以使用以下命令验证配置文件格式：

```bash
docker-compose config
```

这将显示解析后的配置，如果有格式错误会提示具体信息。

### 7. 网络超时问题

在构建Docker镜像时，可能会遇到网络超时错误，特别是在下载大型Python包时。可以尝试以下解决方案：

1. **使用国内镜像源**：Dockerfile中已配置使用阿里云镜像源加速下载
2. **配置Docker镜像加速器**：如上文第2节所述
3. **增加超时时间**：
   ```bash
   export DOCKER_CLIENT_TIMEOUT=120
   export COMPOSE_HTTP_TIMEOUT=120
   docker-compose build
   ```
4. **重试构建**：网络问题通常是临时的，可以多次尝试
5. **手动下载依赖**：在稳定的网络环境下预先下载依赖包

### 8. Docker镜像拉取失败

如果遇到以下错误：
```
ERROR: Service 'web' failed to build: repository docker.io/ubuntu not found: does not exist or no pull access
```
或
```
ERROR: repository docker.io/postgres not found: does not exist or no pull access
```

这表示无法从Docker官方仓库拉取基础镜像，可以尝试以下解决方案：

1. **配置Docker镜像加速器**（推荐）：已完成配置，地址为 https://77n6chx1.mirror.aliyuncs.com
2. **手动拉取基础镜像**：
   ```bash
   # 拉取Ubuntu镜像
   docker pull registry.cn-hangzhou.aliyuncs.com/docker/library/ubuntu:20.04
   docker tag registry.cn-hangzhou.aliyuncs.com/docker/library/ubuntu:20.04 ubuntu:20.04
   
   # 拉取PostgreSQL镜像
   docker pull registry.cn-hangzhou.aliyuncs.com/docker/library/postgres:13
   docker tag registry.cn-hangzhou.aliyuncs.com/docker/library/postgres:13 postgres:13
   ```

### 9. 静态文件收集失败

在构建过程中，您可能会遇到静态文件收集失败的错误：
```
FileNotFoundError: [Errno 2] No such file or directory: '/app/static'
```

这是正常现象，因为项目中可能还没有静态文件。我们的Dockerfile和入口脚本已经处理了这种情况，即使静态文件收集失败也不会影响应用的正常运行。

### 10. 离线安装选项

如果网络问题持续存在，可以考虑离线安装方案：

1. 在网络良好的环境中下载所有依赖：
   ```bash
   # 创建目录用于存储离线包
   mkdir -p offline_packages
   
   # 下载Docker镜像
   docker pull ubuntu:20.04
   docker pull postgres:13
   docker save ubuntu:20.04 -o ubuntu_20.04.tar
   docker save postgres:13 -o postgres_13.tar
   
   # 下载Python依赖包
   pip3 download -r requirements.txt -d offline_packages
   ```

2. 将下载的文件上传到服务器

3. 在服务器上加载镜像和安装依赖：
   ```bash
   # 加载Docker镜像
   docker load -i ubuntu_20.04.tar
   docker load -i postgres_13.tar
   
   # 在Dockerfile中使用本地包安装依赖
   # COPY offline_packages /app/offline_packages
   # RUN pip3 install --find-links /app/offline_packages --no-index -r requirements.txt
   ```